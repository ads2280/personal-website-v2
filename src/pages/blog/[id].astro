---
import Layout from "../../layouts/Layout.astro";
import { getCollection, render } from "astro:content";
import { Image } from "astro:assets";
import { identity } from "../../config";

const { id } = Astro.params;

// Find post by slug (filename without .md)
const posts = await getCollection("posts");
const entry = posts.find(p => p.id.replace(/\.md$/, '') === id);

if (!entry) {
  return Astro.redirect("/blog");
}

// Get post index for numbering
const allPosts = posts.filter(p => !p.data?.draft).sort((a, b) => {
  return new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime();
});
const postIndex = allPosts.findIndex(p => p.id === entry.id) + 1;

const { Content, remarkPluginFrontmatter } = await render(entry);
const claudeSummary = entry.data.claudeSummary;
const claudePrompt = entry.data.claudePrompt || "Too long? Ask Claude";
---

<Layout
  seo={{
    title: entry.data.title,
    description: entry.data.description,
    image: entry.data.image.url,
  }}
>
  <div class="relative min-h-screen">
    <!-- Vertical text on left -->
    <div class="hidden lg:flex items-center justify-center w-16 fixed left-4 top-1/2 -translate-y-1/2">
      <p class="vertical-text text-xs tracking-[0.3em] uppercase opacity-40">
        Article [{String(postIndex).padStart(2, '0')}]
      </p>
    </div>

    <section class="px-6 lg:px-16 pt-16 lg:pt-24 max-w-3xl">
      <!-- Header -->
      <div class="mb-12">
        <a href="/blog" class="text-xs uppercase tracking-wider opacity-40 hover:opacity-100 transition-opacity mb-6 inline-block">
          ‚Üê Back to archive
        </a>
        <span class="bracket-label opacity-60 mb-4 block">[{entry.data.pubDate.toLocaleDateString()}]</span>
        <h1 class="text-3xl lg:text-4xl font-bold tracking-tight mb-4">{entry.data.title}</h1>
        <p class="opacity-60 text-lg mb-6">
          {entry.data.description}
        </p>
        <div class="flex items-center gap-4">
          <Image
            src={identity.logo}
            alt={identity.name}
            width={40}
            height={40}
            class="w-10 h-10 object-cover rounded-full bg-white"
          />
          <div>
            <p class="text-sm font-medium">{identity.name}</p>
            <p class="text-xs opacity-60">
              {remarkPluginFrontmatter.minutesRead}
              {claudeSummary && (
                <button id="claude-explain-btn" class="ml-2 px-2 py-0.5 text-xs bg-gray-200 dark:bg-gray-800 text-black dark:text-white rounded hover:bg-gray-300 dark:hover:bg-gray-700 transition-all uppercase tracking-wider">
                  {claudePrompt}
                </button>
              )}
            </p>
          </div>
        </div>
      </div>

      {claudeSummary && (
        <div id="claude-response" class="hidden mb-12 p-6 rounded bg-gray-100 dark:bg-gray-900 border border-gray-200 dark:border-gray-800">
          <div class="flex items-start gap-4">
            <div class="w-8 h-8 rounded-full bg-[#D97757] flex items-center justify-center flex-shrink-0">
              <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
              </svg>
            </div>
            <div class="flex-1">
              <p class="text-xs uppercase tracking-wider mb-2 text-[#D97757]">[Claude]</p>
              <div id="claude-text" class="text-sm opacity-80 leading-relaxed"></div>
              <span id="cursor" class="hidden animate-pulse">|</span>
            </div>
          </div>
        </div>
      )}

      <!-- Featured image -->
      <Image
        src={entry.data.image.url}
        alt={entry.data.image.alt}
        width={800}
        height={400}
        class="w-full rounded mb-12 opacity-90"
      />

      <!-- Article content -->
      <article
        class="prose dark:prose-invert prose-a:text-blue-600 dark:prose-a:text-blue-300 prose-a:underline-offset-4 prose-headings:mb-2 prose-p:text-gray-600 dark:prose-p:text-[#b3b3b3] prose-headings:tracking-tight"
      >
        <Content />
      </article>
    </section>
  </div>
</Layout>

{claudeSummary && (
  <script define:vars={{ claudeSummary }}>
    const btn = document.getElementById('claude-explain-btn');
    const response = document.getElementById('claude-response');
    const textEl = document.getElementById('claude-text');
    const cursor = document.getElementById('cursor');

    let hasPlayed = false;

    btn.addEventListener('click', async () => {
      if (hasPlayed) {
        const isHidden = response.classList.toggle('hidden');
        btn.textContent = isHidden ? 'Show summary' : 'Hide summary';
        return;
      }

      hasPlayed = true;
      btn.textContent = 'Thinking...';

      await new Promise(r => setTimeout(r, 800));

      response.classList.remove('hidden');
      cursor.classList.remove('hidden');
      btn.textContent = 'Hide summary';

      const text = claudeSummary;
      let i = 0;
      const speed = 12;

      const typeWriter = () => {
        if (i < text.length) {
          textEl.innerHTML += text.charAt(i);
          i++;
          setTimeout(typeWriter, speed + Math.random() * 8);
        } else {
          cursor.classList.add('hidden');
        }
      };

      typeWriter();
    });
  </script>
)}
