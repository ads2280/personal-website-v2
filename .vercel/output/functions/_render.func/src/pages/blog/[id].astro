---
import Layout from "../../layouts/Layout.astro";
import { getEntry, render } from "astro:content";
import { Image } from "astro:assets";
import { identity } from "../../config";

const { id } = Astro.params;
const entry = await getEntry("posts", id as string);

if (!entry) {
  return Astro.redirect("/blog");
}

const { Content, remarkPluginFrontmatter } = await render(entry);
const claudeSummary = entry.data.claudeSummary;
const claudePrompt = entry.data.claudePrompt || "Too long? Ask Claude";
---

<Layout
  seo={{
    title: entry.data.title,
    description: entry.data.description,
    image: entry.data.image.url,
  }}
>
  <section class="mt-10 max-w-2xl mx-auto px-6">
    <h1 class="font-bold text-3xl mb-4">{entry.data.title}</h1>
    <p class="opacity-60 mb-6">
      {entry.data.description}
    </p>
    <div class="flex gap-4 mb-6">
      <Image
        src={identity.logo}
        alt={identity.name}
        width={40}
        height={40}
        class="w-[40px] aspect-square object-cover rounded-full bg-white"
      />
      <div>
        <p class="font-medium">{identity.name}</p>
        <p class="opacity-60">
          {entry.data.pubDate.toLocaleDateString()} Â· {remarkPluginFrontmatter.minutesRead}
          {claudeSummary && (
            <button id="claude-explain-btn" class="ml-2 text-sm opacity-100 underline decoration-dotted underline-offset-4 hover:decoration-solid transition-all">
              {claudePrompt}
            </button>
          )}
        </p>
      </div>
    </div>

    {claudeSummary && (
      <div id="claude-response" class="hidden mb-8 p-4 rounded-lg bg-gray-100 dark:bg-gray-900 border border-gray-200 dark:border-gray-800">
        <div class="flex items-start gap-3">
          <div class="w-6 h-6 rounded-full bg-[#D97757] flex items-center justify-center flex-shrink-0 mt-0.5">
            <svg class="w-3 h-3 text-white" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
            </svg>
          </div>
          <div class="flex-1">
            <p class="font-medium text-sm mb-1 text-[#D97757]">Claude</p>
            <div id="claude-text" class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed"></div>
            <span id="cursor" class="hidden animate-pulse">|</span>
          </div>
        </div>
      </div>
    )}
    <Image
      src={entry.data.image.url}
      alt={entry.data.image.alt}
      width={800}
      height={300}
      class="apsect-video w-full rounded-xl mb-10"
    />
    <article
      class="prose dark:prose-invert prose-a:text-blue-600 dark:prose-a:text-blue-300 prose-a:underline-offset-4 prose-headings:mb-2 prose-p:text-gray-600 dark:prose-p:text-[#b3b3b3]"
    >
      <Content />
    </article>
  </section>
</Layout>

{claudeSummary && (
  <script define:vars={{ claudeSummary }}>
    const btn = document.getElementById('claude-explain-btn');
    const response = document.getElementById('claude-response');
    const textEl = document.getElementById('claude-text');
    const cursor = document.getElementById('cursor');

    let hasPlayed = false;

    btn.addEventListener('click', async () => {
      if (hasPlayed) {
        const isHidden = response.classList.toggle('hidden');
        btn.textContent = isHidden ? 'Show summary' : 'Hide summary';
        return;
      }

      hasPlayed = true;
      btn.textContent = 'Thinking...';

      await new Promise(r => setTimeout(r, 800));

      response.classList.remove('hidden');
      cursor.classList.remove('hidden');
      btn.textContent = 'Hide summary';

      const text = claudeSummary;
      let i = 0;
      const speed = 12;

      const typeWriter = () => {
        if (i < text.length) {
          textEl.innerHTML += text.charAt(i);
          i++;
          setTimeout(typeWriter, speed + Math.random() * 8);
        } else {
          cursor.classList.add('hidden');
        }
      };

      typeWriter();
    });
  </script>
)}
